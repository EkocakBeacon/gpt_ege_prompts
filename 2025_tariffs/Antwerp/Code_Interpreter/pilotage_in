Act like a code interpreter and execute the following code with the variables injected, and then explain the result, and any discrepancy. 
"""
Antwerp Pilotage-In (Block-Size) Fee Calculator
===============================================

Goal
----
Calculate the Antwerp pilotage-in fee using the block-size method with exact tariffs.
Provide:
  1) Step-by-step breakdown (string)
  2) JSON-style summary (dict)

IMPORTANT
---------
- On the pilotage invoice there will be a line called VBS. **Do NOT include VBS** in this calculation.
  It is a separate line item unrelated to pilotage calculations. We explicitly ignore "VBS" lines in any
  invoice text parsing.
- Data usage rule (strict priority):
  1) Use provided variables first.
  2) Only if a variable is missing, try to parse it from the invoice text.
  3) If still missing, leave as "not provided".
- Bunker Adjustment Factor (BAF) **must** be taken from the invoice and added to the final amount.
  If BAF is missing after parsing, we will compute with BAF=0 and add a WARNING that the final amount
  excludes BAF. (You can supply --baf-percentage or include it in invoice text.)

Inputs (use or derive)
----------------------
- length_m : float
- breadth_m : float
- max_summer_draught_m : float (meters)  # If invoice indicates dm explicitly, we can switch (see below).
- routes : list[str]  (must match the exact route keys)
- baf_percentage : float (%)  (can be 0; prefer from invoice text if not supplied)
- cancellation_fee : float (EUR)
- delay_fee : float (EUR)
- storm_pilot_fee : float (EUR)
- special_case_fee : float (EUR)
- custom_volume_discount : float (%) (optional; default 0)

Draught unit handling
---------------------
Block size uses draught in decimeters (dm):
  block_size = length_m * breadth_m * draught_dm
We default to interpreting max_summer_draught_m in meters and convert to dm by *10.
If invoice text clearly shows draught in 'dm' (e.g., "draught 125 dm"), we switch to dm and note the assumption.

Allowed route keys (must match exactly)
---------------------------------------
"Zee-omgekeerd", "Kust-vlissingen rede", "Kust-kust", "Verhaling-kust",
"Redebe-loodsing_kust", "Zee-Vlissingen_rede", "Vlissingen_rede-Antwerp",
"Vlissingen_rede-Gent", "Gent-Antwerp", "Verhaling-Antwerpen", "Verhaling-Gent"

Computation order (exact)
-------------------------
1) Block size
2) For each route: choose bracket (min ≤ block_size ≤ max; if above all, use last row), sum base fees
3) additional_fees_total = cancellation + delay + storm_pilot + special_case
4) volume_discount_value = total_base_fee * (custom_volume_discount / 100)
5) baf_amount = total_base_fee * (baf_percentage / 100)
6) final_amount = total_base_fee + additional_fees_total - volume_discount_value + baf_amount
"""

from __future__ import annotations
import argparse
import json
import math
import os
import re
from typing import Dict, List, Tuple, Optional, Any

ALLOWED_ROUTE_KEYS = [
    "Zee-omgekeerd",
    "Kust-vlissingen rede",
    "Kust-kust",
    "Verhaling-kust",
    "Redebe-loodsing_kust",
    "Zee-Vlissingen_rede",
    "Vlissingen_rede-Antwerp",
    "Vlissingen_rede-Gent",
    "Gent-Antwerp",
    "Verhaling-Antwerpen",
    "Verhaling-Gent",
]

# Tariff table (exactly as provided)
TARIFF_TABLE: List[Dict[str, Any]] = [
  {"min": 0, "max": 1999, "Zee-omgekeerd": 191, "Kust-vlissingen rede": 153, "Kust-kust": 180, "Verhaling-kust": 48, "Redebe-loodsing_kust": 59, "Zee-Vlissingen_rede": 234, "Vlissingen_rede-Antwerp": 121, "Vlissingen_rede-Gent": 104, "Gent-Antwerp": 129, "Verhaling-Antwerpen": 73, "Verhaling-Gent": 61},
  {"min": 2000, "max": 3999, "Zee-omgekeerd": 329, "Kust-vlissingen rede": 264, "Kust-kust": 312, "Verhaling-kust": 83, "Redebe-loodsing_kust": 102, "Zee-Vlissingen_rede": 361, "Vlissingen_rede-Antwerp": 181, "Vlissingen_rede-Gent": 157, "Gent-Antwerp": 192, "Verhaling-Antwerpen": 110, "Verhaling-Gent": 91},
  {"min": 4000, "max": 5999, "Zee-omgekeerd": 552, "Kust-vlissingen rede": 442, "Kust-kust": 526, "Verhaling-kust": 139, "Redebe-loodsing_kust": 167, "Zee-Vlissingen_rede": 589, "Vlissingen_rede-Antwerp": 310, "Vlissingen_rede-Gent": 263, "Gent-Antwerp": 325, "Verhaling-Antwerpen": 188, "Verhaling-Gent": 157},
  {"min": 6000, "max": 7999, "Zee-omgekeerd": 803, "Kust-vlissingen rede": 642, "Kust-kust": 763, "Verhaling-kust": 202, "Redebe-loodsing_kust": 241, "Zee-Vlissingen_rede": 841, "Vlissingen_rede-Antwerp": 450, "Vlissingen_rede-Gent": 381, "Gent-Antwerp": 472, "Verhaling-Antwerpen": 269, "Verhaling-Gent": 227},
  {"min": 8000, "max": 9999, "Zee-omgekeerd": 1074, "Kust-vlissingen rede": 863, "Kust-kust": 1023, "Verhaling-kust": 269, "Redebe-loodsing_kust": 324, "Zee-Vlissingen_rede": 1119, "Vlissingen_rede-Antwerp": 605, "Vlissingen_rede-Gent": 514, "Gent-Antwerp": 634, "Verhaling-Antwerpen": 363, "Verhaling-Gent": 304},
  {"min": 10000, "max": 12499, "Zee-omgekeerd": 1450, "Kust-vlissingen rede": 1159, "Kust-kust": 1375, "Verhaling-kust": 363, "Redebe-loodsing_kust": 437, "Zee-Vlissingen_rede": 1496, "Vlissingen_rede-Antwerp": 815, "Vlissingen_rede-Gent": 694, "Gent-Antwerp": 856, "Verhaling-Antwerpen": 489, "Verhaling-Gent": 409},
  {"min": 12500, "max": 14999, "Zee-omgekeerd": 1575, "Kust-vlissingen rede": 1262, "Kust-kust": 1497, "Verhaling-kust": 390, "Redebe-loodsing_kust": 467, "Zee-Vlissingen_rede": 1623, "Vlissingen_rede-Antwerp": 886, "Vlissingen_rede-Gent": 731, "Gent-Antwerp": 960, "Verhaling-Antwerpen": 513, "Verhaling-Gent": 443},
  {"min": 15000, "max": 17499, "Zee-omgekeerd": 1701, "Kust-vlissingen rede": 1362, "Kust-kust": 1617, "Verhaling-kust": 428, "Redebe-loodsing_kust": 510, "Zee-Vlissingen_rede": 1749, "Vlissingen_rede-Antwerp": 959, "Vlissingen_rede-Gent": 813, "Gent-Antwerp": 1005, "Verhaling-Antwerpen": 574, "Verhaling-Gent": 480},
  {"min": 17500, "max": 19999, "Zee-omgekeerd": 1829, "Kust-vlissingen rede": 1463, "Kust-kust": 1737, "Verhaling-kust": 459, "Redebe-loodsing_kust": 549, "Zee-Vlissingen_rede": 1877, "Vlissingen_rede-Antwerp": 1029, "Vlissingen_rede-Gent": 873, "Gent-Antwerp": 1081, "Verhaling-Antwerpen": 618, "Verhaling-Gent": 516},
  {"min": 20000, "max": 22499, "Zee-omgekeerd": 1955, "Kust-vlissingen rede": 1563, "Kust-kust": 1857, "Verhaling-kust": 489, "Redebe-loodsing_kust": 589, "Zee-Vlissingen_rede": 2004, "Vlissingen_rede-Antwerp": 1100, "Vlissingen_rede-Gent": 935, "Gent-Antwerp": 1156, "Verhaling-Antwerpen": 661, "Verhaling-Gent": 550},
  {"min": 22500, "max": 24999, "Zee-omgekeerd": 2083, "Kust-vlissingen rede": 1666, "Kust-kust": 1979, "Verhaling-kust": 521, "Redebe-loodsing_kust": 626, "Zee-Vlissingen_rede": 2132, "Vlissingen_rede-Antwerp": 1172, "Vlissingen_rede-Gent": 997, "Gent-Antwerp": 1232, "Verhaling-Antwerpen": 703, "Verhaling-Gent": 589},
  {"min": 25000, "max": 27499, "Zee-omgekeerd": 2209, "Kust-vlissingen rede": 1766, "Kust-kust": 2097, "Verhaling-kust": 555, "Redebe-loodsing_kust": 663, "Zee-Vlissingen_rede": 2259, "Vlissingen_rede-Antwerp": 1242, "Vlissingen_rede-Gent": 1058, "Gent-Antwerp": 1305, "Verhaling-Antwerpen": 745, "Verhaling-Gent": 624},
  {"min": 27500, "max": 29999, "Zee-omgekeerd": 2334, "Kust-vlissingen rede": 1868, "Kust-kust": 2218, "Verhaling-kust": 586, "Redebe-loodsing_kust": 702, "Zee-Vlissingen_rede": 2386, "Vlissingen_rede-Antwerp": 1315, "Vlissingen_rede-Gent": 1119, "Gent-Antwerp": 1382, "Verhaling-Antwerpen": 789, "Verhaling-Gent": 659},
  {"min": 30000, "max": 32499, "Zee-omgekeerd": 2461, "Kust-vlissingen rede": 1969, "Kust-kust": 2338, "Verhaling-kust": 617, "Redebe-loodsing_kust": 739, "Zee-Vlissingen_rede": 2513, "Vlissingen_rede-Antwerp": 1387, "Vlissingen_rede-Gent": 1178, "Gent-Antwerp": 1456, "Verhaling-Antwerpen": 832, "Verhaling-Gent": 694},
  {"min": 32500, "max": 34999, "Zee-omgekeerd": 2588, "Kust-vlissingen rede": 2070, "Kust-kust": 2457, "Verhaling-kust": 649, "Redebe-loodsing_kust": 778, "Zee-Vlissingen_rede": 2638, "Vlissingen_rede-Antwerp": 1458, "Vlissingen_rede-Gent": 1239, "Gent-Antwerp": 1531, "Verhaling-Antwerpen": 875, "Verhaling-Gent": 731},
  {"min": 35000, "max": 37499, "Zee-omgekeerd": 2714, "Kust-vlissingen rede": 2170, "Kust-kust": 2579, "Verhaling-kust": 679, "Redebe-loodsing_kust": 815, "Zee-Vlissingen_rede": 2764, "Vlissingen_rede-Antwerp": 1528, "Vlissingen_rede-Gent": 1299, "Gent-Antwerp": 1605, "Verhaling-Antwerpen": 918, "Verhaling-Gent": 765},
  {"min": 37500, "max": 39999, "Zee-omgekeerd": 2841, "Kust-vlissingen rede": 2273, "Kust-kust": 2698, "Verhaling-kust": 712, "Redebe-loodsing_kust": 854, "Zee-Vlissingen_rede": 2893, "Vlissingen_rede-Antwerp": 1601, "Vlissingen_rede-Gent": 1361, "Gent-Antwerp": 1681, "Verhaling-Antwerpen": 961, "Verhaling-Gent": 801},
  {"min": 40000, "max": 42499, "Zee-omgekeerd": 2965, "Kust-vlissingen rede": 2373, "Kust-kust": 2818, "Verhaling-kust": 743, "Redebe-loodsing_kust": 891, "Zee-Vlissingen_rede": 3020, "Vlissingen_rede-Antwerp": 1672, "Vlissingen_rede-Gent": 1422, "Gent-Antwerp": 1757, "Verhaling-Antwerpen": 1004, "Verhaling-Gent": 837},
  {"min": 42500, "max": 44999, "Zee-omgekeerd": 3092, "Kust-vlissingen rede": 2475, "Kust-kust": 2939, "Verhaling-kust": 774, "Redebe-loodsing_kust": 930, "Zee-Vlissingen_rede": 3147, "Vlissingen_rede-Antwerp": 1743, "Vlissingen_rede-Gent": 1483, "Gent-Antwerp": 1830, "Verhaling-Antwerpen": 1047, "Verhaling-Gent": 872},
  {"min": 45000, "max": 47499, "Zee-omgekeerd": 3218, "Kust-vlissingen rede": 2574, "Kust-kust": 3058, "Verhaling-kust": 807, "Redebe-loodsing_kust": 966, "Zee-Vlissingen_rede": 3274, "Vlissingen_rede-Antwerp": 1815, "Vlissingen_rede-Gent": 1542, "Gent-Antwerp": 1905, "Verhaling-Antwerpen": 1089, "Verhaling-Gent": 908},
  {"min": 47500, "max": 49999, "Zee-omgekeerd": 3346, "Kust-vlissingen rede": 2677, "Kust-kust": 3180, "Verhaling-kust": 837, "Redebe-loodsing_kust": 1004, "Zee-Vlissingen_rede": 3401, "Vlissingen_rede-Antwerp": 1886, "Vlissingen_rede-Gent": 1604, "Gent-Antwerp": 1981, "Verhaling-Antwerpen": 1131, "Verhaling-Gent": 942},
  {"min": 50000, "max": 54999, "Zee-omgekeerd": 3473, "Kust-vlissingen rede": 2779, "Kust-kust": 3299, "Verhaling-kust": 870, "Redebe-loodsing_kust": 1042, "Zee-Vlissingen_rede": 3527, "Vlissingen_rede-Antwerp": 1958, "Vlissingen_rede-Gent": 1665, "Gent-Antwerp": 2056, "Verhaling-Antwerpen": 1175, "Verhaling-Gent": 981},
  {"min": 55000, "max": 59999, "Zee-omgekeerd": 3600, "Kust-vlissingen rede": 2880, "Kust-kust": 3419, "Verhaling-kust": 900, "Redebe-loodsing_kust": 1082, "Zee-Vlissingen_rede": 3655, "Vlissingen_rede-Antwerp": 2028, "Vlissingen_rede-Gent": 1724, "Gent-Antwerp": 2130, "Verhaling-Antwerpen": 1218, "Verhaling-Gent": 1017},
  {"min": 60000, "max": 64999, "Zee-omgekeerd": 3725, "Kust-vlissingen rede": 2981, "Kust-kust": 3540, "Verhaling-kust": 933, "Redebe-loodsing_kust": 1119, "Zee-Vlissingen_rede": 3781, "Vlissingen_rede-Antwerp": 2100, "Vlissingen_rede-Gent": 1786, "Gent-Antwerp": 2204, "Verhaling-Antwerpen": 1262, "Verhaling-Gent": 1051},
  {"min": 65000, "max": 69999, "Zee-omgekeerd": 3851, "Kust-vlissingen rede": 3083, "Kust-kust": 3658, "Verhaling-kust": 964, "Redebe-loodsing_kust": 1157, "Zee-Vlissingen_rede": 3909, "Vlissingen_rede-Antwerp": 2171, "Vlissingen_rede-Gent": 1847, "Gent-Antwerp": 2282, "Verhaling-Antwerpen": 1304, "Verhaling-Gent": 1088},
  {"min": 70000, "max": 74999, "Zee-omgekeerd": 3978, "Kust-vlissingen rede": 3183, "Kust-kust": 3780, "Verhaling-kust": 996, "Redebe-loodsing_kust": 1194, "Zee-Vlissingen_rede": 4036, "Vlissingen_rede-Antwerp": 2243, "Vlissingen_rede-Gent": 1906, "Gent-Antwerp": 2355, "Verhaling-Antwerpen": 1346, "Verhaling-Gent": 1123},
  {"min": 75000, "max": 79999, "Zee-omgekeerd": 4105, "Kust-vlissingen rede": 3284, "Kust-kust": 3899, "Verhaling-kust": 1026, "Redebe-loodsing_kust": 1234, "Zee-Vlissingen_rede": 4161, "Vlissingen_rede-Antwerp": 2315, "Vlissingen_rede-Gent": 1966, "Gent-Antwerp": 2431, "Verhaling-Antwerpen": 1390, "Verhaling-Gent": 1158},
  {"min": 80000, "max": 84999, "Zee-omgekeerd": 4233, "Kust-vlissingen rede": 3386, "Kust-kust": 4019, "Verhaling-kust": 1060, "Redebe-loodsing_kust": 1270, "Zee-Vlissingen_rede": 4289, "Vlissingen_rede-Antwerp": 2386, "Vlissingen_rede-Gent": 2028, "Gent-Antwerp": 2504, "Verhaling-Antwerpen": 1432, "Verhaling-Gent": 1193},
  {"min": 85000, "max": 89999, "Zee-omgekeerd": 4356, "Kust-vlissingen rede": 3486, "Kust-kust": 4139, "Verhaling-kust": 1091, "Redebe-loodsing_kust": 1308, "Zee-Vlissingen_rede": 4416, "Vlissingen_rede-Antwerp": 2457, "Vlissingen_rede-Gent": 2089, "Gent-Antwerp": 2581, "Verhaling-Antwerpen": 1473, "Verhaling-Gent": 1232},
  {"min": 90000, "max": 94999, "Zee-omgekeerd": 4484, "Kust-vlissingen rede": 3587, "Kust-kust": 4259, "Verhaling-kust": 1123, "Redebe-loodsing_kust": 1346, "Zee-Vlissingen_rede": 4543, "Vlissingen_rede-Antwerp": 2530, "Vlissingen_rede-Gent": 2150, "Gent-Antwerp": 2657, "Verhaling-Antwerpen": 1519, "Verhaling-Gent": 1266},
  {"min": 95000, "max": 99999, "Zee-omgekeerd": 4610, "Kust-vlissingen rede": 3688, "Kust-kust": 4381, "Verhaling-kust": 1155, "Redebe-loodsing_kust": 1386, "Zee-Vlissingen_rede": 4670, "Vlissingen_rede-Antwerp": 2600, "Vlissingen_rede-Gent": 2211, "Gent-Antwerp": 2730, "Verhaling-Antwerpen": 1561, "Verhaling-Gent": 1301},
  {"min": 100000, "max": 109999, "Zee-omgekeerd": 4738, "Kust-vlissingen rede": 3789, "Kust-kust": 4500, "Verhaling-kust": 1185, "Redebe-loodsing_kust": 1422, "Zee-Vlissingen_rede": 4799, "Vlissingen_rede-Antwerp": 2672, "Vlissingen_rede-Gent": 2269, "Gent-Antwerp": 2807, "Verhaling-Antwerpen": 1605, "Verhaling-Gent": 1337},
  {"min": 110000, "max": 119999, "Zee-omgekeerd": 4840, "Kust-vlissingen rede": 3871, "Kust-kust": 4598, "Verhaling-kust": 1211, "Redebe-loodsing_kust": 1455, "Zee-Vlissingen_rede": 4899, "Vlissingen_rede-Antwerp": 2729, "Vlissingen_rede-Gent": 2320, "Gent-Antwerp": 2866, "Verhaling-Antwerpen": 1638, "Verhaling-Gent": 1366},
  {"min": 120000, "max": 129999, "Zee-omgekeerd": 4939, "Kust-vlissingen rede": 3951, "Kust-kust": 4691, "Verhaling-kust": 1236, "Redebe-loodsing_kust": 1484, "Zee-Vlissingen_rede": 5001, "Vlissingen_rede-Antwerp": 2786, "Vlissingen_rede-Gent": 2369, "Gent-Antwerp": 2927, "Verhaling-Antwerpen": 1672, "Verhaling-Gent": 1394},
  {"min": 130000, "max": 139999, "Zee-omgekeerd": 5040, "Kust-vlissingen rede": 4034, "Kust-kust": 4788, "Verhaling-kust": 1262, "Redebe-loodsing_kust": 1514, "Zee-Vlissingen_rede": 5101, "Vlissingen_rede-Antwerp": 2844, "Vlissingen_rede-Gent": 2416, "Gent-Antwerp": 2986, "Verhaling-Antwerpen": 1706, "Verhaling-Gent": 1422},
  {"min": 140000, "max": 149999, "Zee-omgekeerd": 5142, "Kust-vlissingen rede": 4112, "Kust-kust": 4884, "Verhaling-kust": 1287, "Redebe-loodsing_kust": 1545, "Zee-Vlissingen_rede": 5203, "Vlissingen_rede-Antwerp": 2900, "Vlissingen_rede-Gent": 2465, "Gent-Antwerp": 3047, "Verhaling-Antwerpen": 1741, "Verhaling-Gent": 1453},
  {"min": 150000, "max": 159999, "Zee-omgekeerd": 5242, "Kust-vlissingen rede": 4194, "Kust-kust": 4980, "Verhaling-kust": 1312, "Redebe-loodsing_kust": 1573, "Zee-Vlissingen_rede": 5305, "Vlissingen_rede-Antwerp": 2958, "Vlissingen_rede-Gent": 2515, "Gent-Antwerp": 3107, "Verhaling-Antwerpen": 1776, "Verhaling-Gent": 1481},
  {"min": 160000, "max": 169999, "Zee-omgekeerd": 5344, "Kust-vlissingen rede": 4276, "Kust-kust": 5078, "Verhaling-kust": 1337, "Redebe-loodsing_kust": 1605, "Zee-Vlissingen_rede": 5407, "Vlissingen_rede-Antwerp": 3015, "Vlissingen_rede-Gent": 2562, "Gent-Antwerp": 3165, "Verhaling-Antwerpen": 1810, "Verhaling-Gent": 1508},
  {"min": 170000, "max": 179999, "Zee-omgekeerd": 5445, "Kust-vlissingen rede": 4355, "Kust-kust": 5172, "Verhaling-kust": 1364, "Redebe-loodsing_kust": 1634, "Zee-Vlissingen_rede": 5508, "Vlissingen_rede-Antwerp": 3071, "Vlissingen_rede-Gent": 2611, "Gent-Antwerp": 3224, "Verhaling-Antwerpen": 1843, "Verhaling-Gent": 1536},
  {"min": 180000, "max": 189999, "Zee-omgekeerd": 5546, "Kust-vlissingen rede": 4438, "Kust-kust": 5269, "Verhaling-kust": 1389, "Redebe-loodsing_kust": 1666, "Zee-Vlissingen_rede": 5610, "Vlissingen_rede-Antwerp": 3127, "Vlissingen_rede-Gent": 2659, "Gent-Antwerp": 3285, "Verhaling-Antwerpen": 1877, "Verhaling-Gent": 1564},
  {"min": 190000, "max": 199999, "Zee-omgekeerd": 5647, "Kust-vlissingen rede": 4518, "Kust-kust": 5366, "Verhaling-kust": 1414, "Redebe-loodsing_kust": 1695, "Zee-Vlissingen_rede": 5712, "Vlissingen_rede-Antwerp": 3187, "Vlissingen_rede-Gent": 2710, "Gent-Antwerp": 3346, "Verhaling-Antwerpen": 1913, "Verhaling-Gent": 1594},
  {"min": 200000, "max": 209999, "Zee-omgekeerd": 5747, "Kust-vlissingen rede": 4599, "Kust-kust": 5462, "Verhaling-kust": 1437, "Redebe-loodsing_kust": 1725, "Zee-Vlissingen_rede": 5813, "Vlissingen_rede-Antwerp": 3243, "Vlissingen_rede-Gent": 2757, "Gent-Antwerp": 3406, "Verhaling-Antwerpen": 1947, "Verhaling-Gent": 1623},
  {"min": 210000, "max": 219999, "Zee-omgekeerd": 5849, "Kust-vlissingen rede": 4681, "Kust-kust": 5559, "Verhaling-kust": 1463, "Redebe-loodsing_kust": 1757, "Zee-Vlissingen_rede": 5915, "Vlissingen_rede-Antwerp": 3301, "Vlissingen_rede-Gent": 2807, "Gent-Antwerp": 3465, "Verhaling-Antwerpen": 1982, "Verhaling-Gent": 1651},
  {"min": 220000, "max": 229999, "Zee-omgekeerd": 5950, "Kust-vlissingen rede": 4761, "Kust-kust": 5651, "Verhaling-kust": 1488, "Redebe-loodsing_kust": 1787, "Zee-Vlissingen_rede": 6016, "Vlissingen_rede-Antwerp": 3357, "Vlissingen_rede-Gent": 2854, "Gent-Antwerp": 3524, "Verhaling-Antwerpen": 2016, "Verhaling-Gent": 1680},
  {"min": 230000, "max": 239999, "Zee-omgekeerd": 6050, "Kust-vlissingen rede": 4842, "Kust-kust": 5750, "Verhaling-kust": 1515, "Redebe-loodsing_kust": 1818, "Zee-Vlissingen_rede": 6120, "Vlissingen_rede-Antwerp": 3416, "Vlissingen_rede-Gent": 2904, "Gent-Antwerp": 3586, "Verhaling-Antwerpen": 2049, "Verhaling-Gent": 1710},
  {"min": 240000, "max": 249999, "Zee-omgekeerd": 6154, "Kust-vlissingen rede": 4924, "Kust-kust": 5846, "Verhaling-kust": 1540, "Redebe-loodsing_kust": 1848, "Zee-Vlissingen_rede": 6220, "Vlissingen_rede-Antwerp": 3472, "Vlissingen_rede-Gent": 2950, "Gent-Antwerp": 3646, "Verhaling-Antwerpen": 2084, "Verhaling-Gent": 1737},
  {"min": 250000, "max": 259999, "Zee-omgekeerd": 6254, "Kust-vlissingen rede": 5003, "Kust-kust": 5941, "Verhaling-kust": 1564, "Redebe-loodsing_kust": 1877, "Zee-Vlissingen_rede": 6321, "Vlissingen_rede-Antwerp": 3529, "Vlissingen_rede-Gent": 2999, "Gent-Antwerp": 3706, "Verhaling-Antwerpen": 2118, "Verhaling-Gent": 1765},
  {"min": 260000, "max": 269999, "Zee-omgekeerd": 6356, "Kust-vlissingen rede": 5085, "Kust-kust": 6038, "Verhaling-kust": 1590, "Redebe-loodsing_kust": 1910, "Zee-Vlissingen_rede": 6421, "Vlissingen_rede-Antwerp": 3586, "Vlissingen_rede-Gent": 3048, "Gent-Antwerp": 3766, "Verhaling-Antwerpen": 2154, "Verhaling-Gent": 1793},
  {"min": 270000, "max": 279999, "Zee-omgekeerd": 6458, "Kust-vlissingen rede": 5168, "Kust-kust": 6134, "Verhaling-kust": 1616, "Redebe-loodsing_kust": 1938, "Zee-Vlissingen_rede": 6524, "Vlissingen_rede-Antwerp": 3644, "Vlissingen_rede-Gent": 3096, "Gent-Antwerp": 3825, "Verhaling-Antwerpen": 2188, "Verhaling-Gent": 1824},
  {"min": 280000, "max": 289999, "Zee-omgekeerd": 6559, "Kust-vlissingen rede": 5246, "Kust-kust": 6231, "Verhaling-kust": 1640, "Redebe-loodsing_kust": 1969, "Zee-Vlissingen_rede": 6625, "Vlissingen_rede-Antwerp": 3700, "Vlissingen_rede-Gent": 3146, "Gent-Antwerp": 3886, "Verhaling-Antwerpen": 2220, "Verhaling-Gent": 1853},
  {"min": 290000, "max": 299999, "Zee-omgekeerd": 6659, "Kust-vlissingen rede": 5328, "Kust-kust": 6326, "Verhaling-kust": 1667, "Redebe-loodsing_kust": 1998, "Zee-Vlissingen_rede": 6727, "Vlissingen_rede-Antwerp": 3759, "Vlissingen_rede-Gent": 3194, "Gent-Antwerp": 3947, "Verhaling-Antwerpen": 2256, "Verhaling-Gent": 1881},
  {"min": 300000, "max": 309999, "Zee-omgekeerd": 6760, "Kust-vlissingen rede": 5408, "Kust-kust": 6421, "Verhaling-kust": 1692, "Redebe-loodsing_kust": 2029, "Zee-Vlissingen_rede": 6829, "Vlissingen_rede-Antwerp": 3816, "Vlissingen_rede-Gent": 3243, "Gent-Antwerp": 4006, "Verhaling-Antwerpen": 2289, "Verhaling-Gent": 1910},
  {"min": 310000, "max": 319999, "Zee-omgekeerd": 6862, "Kust-vlissingen rede": 5491, "Kust-kust": 6519, "Verhaling-kust": 1716, "Redebe-loodsing_kust": 2059, "Zee-Vlissingen_rede": 6931, "Vlissingen_rede-Antwerp": 3871, "Vlissingen_rede-Gent": 3291, "Gent-Antwerp": 4066, "Verhaling-Antwerpen": 2323, "Verhaling-Gent": 1936},
  {"min": 320000, "max": 329999, "Zee-omgekeerd": 6963, "Kust-vlissingen rede": 5570, "Kust-kust": 6615, "Verhaling-kust": 1741, "Redebe-loodsing_kust": 2090, "Zee-Vlissingen_rede": 7033, "Vlissingen_rede-Antwerp": 3929, "Vlissingen_rede-Gent": 3341, "Gent-Antwerp": 4125, "Verhaling-Antwerpen": 2358, "Verhaling-Gent": 1965},
  {"min": 330000, "max": 339999, "Zee-omgekeerd": 7063, "Kust-vlissingen rede": 5650, "Kust-kust": 6711, "Verhaling-kust": 1766, "Redebe-loodsing_kust": 2120, "Zee-Vlissingen_rede": 7134, "Vlissingen_rede-Antwerp": 3985, "Vlissingen_rede-Gent": 3389, "Gent-Antwerp": 4186, "Verhaling-Antwerpen": 2392, "Verhaling-Gent": 1994},
  {"min": 340000, "max": 349999, "Zee-omgekeerd": 7166, "Kust-vlissingen rede": 5734, "Kust-kust": 6806, "Verhaling-kust": 1792, "Redebe-loodsing_kust": 2150, "Zee-Vlissingen_rede": 7236, "Vlissingen_rede-Antwerp": 4044, "Vlissingen_rede-Gent": 3438, "Gent-Antwerp": 4245, "Verhaling-Antwerpen": 2426, "Verhaling-Gent": 2022},
  {"min": 350000, "max": 359999, "Zee-omgekeerd": 7266, "Kust-vlissingen rede": 5813, "Kust-kust": 6903, "Verhaling-kust": 1819, "Redebe-loodsing_kust": 2181, "Zee-Vlissingen_rede": 7337, "Vlissingen_rede-Antwerp": 4101, "Vlissingen_rede-Gent": 3486, "Gent-Antwerp": 4306, "Verhaling-Antwerpen": 2461, "Verhaling-Gent": 2050},
  {"min": 360000, "max": 369999, "Zee-omgekeerd": 7368, "Kust-vlissingen rede": 5894, "Kust-kust": 6997, "Verhaling-kust": 1843, "Redebe-loodsing_kust": 2210, "Zee-Vlissingen_rede": 7439, "Vlissingen_rede-Antwerp": 4158, "Vlissingen_rede-Gent": 3534, "Gent-Antwerp": 4365, "Verhaling-Antwerpen": 2495, "Verhaling-Gent": 2080},
  {"min": 370000, "max": 379999, "Zee-omgekeerd": 7467, "Kust-vlissingen rede": 5975, "Kust-kust": 7091, "Verhaling-kust": 1869, "Redebe-loodsing_kust": 2239, "Zee-Vlissingen_rede": 7543, "Vlissingen_rede-Antwerp": 4215, "Vlissingen_rede-Gent": 3581, "Gent-Antwerp": 4424, "Verhaling-Antwerpen": 2527, "Verhaling-Gent": 2108},
  {"min": 380000, "max": 389999, "Zee-omgekeerd": 7568, "Kust-vlissingen rede": 6058, "Kust-kust": 7187, "Verhaling-kust": 1895, "Redebe-loodsing_kust": 2268, "Zee-Vlissingen_rede": 7644, "Vlissingen_rede-Antwerp": 4270, "Vlissingen_rede-Gent": 3627, "Gent-Antwerp": 4486, "Verhaling-Antwerpen": 2561, "Verhaling-Gent": 2136},
  {"min": 390000, "max": 399999, "Zee-omgekeerd": 7668, "Kust-vlissingen rede": 6139, "Kust-kust": 7283, "Verhaling-kust": 1921, "Redebe-loodsing_kust": 2297, "Zee-Vlissingen_rede": 7745, "Vlissingen_rede-Antwerp": 4326, "Vlissingen_rede-Gent": 3675, "Gent-Antwerp": 4547, "Verhaling-Antwerpen": 2594, "Verhaling-Gent": 2164},
  {"min": 400000, "max": 409999, "Zee-omgekeerd": 7768, "Kust-vlissingen rede": 6221, "Kust-kust": 7378, "Verhaling-kust": 1947, "Redebe-loodsing_kust": 2326, "Zee-Vlissingen_rede": 7847, "Vlissingen_rede-Antwerp": 4383, "Vlissingen_rede-Gent": 3723, "Gent-Antwerp": 4609, "Verhaling-Antwerpen": 2627, "Verhaling-Gent": 2192},
  {"min": 410000, "max": 419999, "Zee-omgekeerd": 7868, "Kust-vlissingen rede": 6302, "Kust-kust": 7475, "Verhaling-kust": 1973, "Redebe-loodsing_kust": 2356, "Zee-Vlissingen_rede": 7948, "Vlissingen_rede-Antwerp": 4439, "Vlissingen_rede-Gent": 3770, "Gent-Antwerp": 4670, "Verhaling-Antwerpen": 2661, "Verhaling-Gent": 2220},
  {"min": 420000, "max": 429999, "Zee-omgekeerd": 7969, "Kust-vlissingen rede": 6385, "Kust-kust": 7571, "Verhaling-kust": 1998, "Redebe-loodsing_kust": 2385, "Zee-Vlissingen_rede": 8049, "Vlissingen_rede-Antwerp": 4495, "Vlissingen_rede-Gent": 3818, "Gent-Antwerp": 4732, "Verhaling-Antwerpen": 2694, "Verhaling-Gent": 2248},
  {"min": 430000, "max": 439999, "Zee-omgekeerd": 8069, "Kust-vlissingen rede": 6467, "Kust-kust": 7667, "Verhaling-kust": 2024, "Redebe-loodsing_kust": 2414, "Zee-Vlissingen_rede": 8151, "Vlissingen_rede-Antwerp": 4551, "Vlissingen_rede-Gent": 3865, "Gent-Antwerp": 4793, "Verhaling-Antwerpen": 2728, "Verhaling-Gent": 2276},
  {"min": 440000, "max": 449999, "Zee-omgekeerd": 8169, "Kust-vlissingen rede": 6548, "Kust-kust": 7763, "Verhaling-kust": 2050, "Redebe-loodsing_kust": 2443, "Zee-Vlissingen_rede": 8252, "Vlissingen_rede-Antwerp": 4607, "Vlissingen_rede-Gent": 3913, "Gent-Antwerp": 4855, "Verhaling-Antwerpen": 2761, "Verhaling-Gent": 2304},
  {"min": 450000, "max": 459999, "Zee-omgekeerd": 8269, "Kust-vlissingen rede": 6631, "Kust-kust": 7859, "Verhaling-kust": 2076, "Redebe-loodsing_kust": 2472, "Zee-Vlissingen_rede": 8353, "Vlissingen_rede-Antwerp": 4663, "Vlissingen_rede-Gent": 3960, "Gent-Antwerp": 4916, "Verhaling-Antwerpen": 2794, "Verhaling-Gent": 2332},
  {"min": 460000, "max": 469999, "Zee-omgekeerd": 8370, "Kust-vlissingen rede": 6713, "Kust-kust": 7954, "Verhaling-kust": 2103, "Redebe-loodsing_kust": 2501, "Zee-Vlissingen_rede": 8454, "Vlissingen_rede-Antwerp": 4719, "Vlissingen_rede-Gent": 4008, "Gent-Antwerp": 4977, "Verhaling-Antwerpen": 2828, "Verhaling-Gent": 2360},
  {"min": 470000, "max": 479999, "Zee-omgekeerd": 8470, "Kust-vlissingen rede": 6794, "Kust-kust": 8050, "Verhaling-kust": 2129, "Redebe-loodsing_kust": 2531, "Zee-Vlissingen_rede": 8557, "Vlissingen_rede-Antwerp": 4775, "Vlissingen_rede-Gent": 4055, "Gent-Antwerp": 5039, "Verhaling-Antwerpen": 2862, "Verhaling-Gent": 2388},
  {"min": 480000, "max": 999999, "Zee-omgekeerd": 8570, "Kust-vlissingen rede": 6876, "Kust-kust": 8146, "Verhaling-kust": 2155, "Redebe-loodsing_kust": 2560, "Zee-Vlissingen_rede": 8658, "Vlissingen_rede-Antwerp": 4832, "Vlissingen_rede-Gent": 4102, "Gent-Antwerp": 5100, "Verhaling-Antwerpen": 2895, "Verhaling-Gent": 2416}
]

def _parse_number(s: str) -> Optional[float]:
    s = s.strip().replace("\u00A0", " ")
    m = re.findall(r"[-+]?\d{1,3}(?:[.,]\d{3})*(?:[.,]\d+)?|[-+]?\d+(?:[.,]\d+)?", s)
    if not m:
        return None
    # take first match; normalize thousands/decimal (assume last separator is decimal)
    raw = m[0]
    if raw.count(",") and raw.count("."):
        # remove thousands sep
        if raw.rfind(",") > raw.rfind("."):
            raw = raw.replace(".", "").replace(",", ".")
        else:
            raw = raw.replace(",", "")
    else:
        raw = raw.replace(",", ".")
    try:
        return float(raw)
    except:
        return None

def parse_invoice_text(invoice_text: str) -> Dict[str, Optional[float]]:
    """
    Parse optional values from invoice text:
      - BAF percentage (preferred)
      - cancellation/delay/storm_pilot/special_case fees (EUR)
      - draught value with unit 'dm' if explicitly present
    We ignore any lines that contain 'VBS' (case-insensitive).
    """
    if not invoice_text:
        return {}

    # Drop VBS lines
    lines = [ln for ln in invoice_text.splitlines() if "vbs" not in ln.lower()]

    text = "\n".join(lines)

    out: Dict[str, Optional[float]] = {}

    # BAF percentage patterns
    baf_patterns = [
        r"\b(?:BAF|Bunker\s*Adjustment(?:\s*Factor)?)\s*[:=]?\s*([0-9]+(?:[.,][0-9]+)?)\s*%",
        r"\bBAF\s*\(\s*([0-9]+(?:[.,][0-9]+)?)\s*%\s*\)"
    ]
    for pat in baf_patterns:
        m = re.search(pat, text, re.IGNORECASE)
        if m:
            out["baf_percentage"] = _parse_number(m.group(1))
            break

    # Fee patterns (EUR)
    fee_map = {
        "cancellation_fee": r"\bcancellation(?:\s*fee)?\b[:=]?\s*(?:EUR|€)?\s*([0-9][\d.,]*)",
        "delay_fee": r"\bdelay(?:\s*fee)?\b[:=]?\s*(?:EUR|€)?\s*([0-9][\d.,]*)",
        "storm_pilot_fee": r"\bstorm(?:\s*p?ilot)?(?:\s*fee)?\b[:=]?\s*(?:EUR|€)?\s*([0-9][\d.,]*)",
        "special_case_fee": r"\bspecial\s*case(?:\s*fee)?\b[:=]?\s*(?:EUR|€)?\s*([0-9][\d.,]*)",
    }
    for key, pat in fee_map.items():
        m = re.search(pat, text, re.IGNORECASE)
        if m:
            out[key] = _parse_number(m.group(1))

    # Draught in dm (explicit)
    m_dm = re.search(r"\b(draught|draft|diepgang)\b[^0-9%]*([0-9][\d.,]*)\s*dm\b", text, re.IGNORECASE)
    if m_dm:
        out["draught_dm_explicit"] = _parse_number(m_dm.group(2))

    return out

def find_bracket(block_size: float) -> Dict[str, Any]:
    for row in TARIFF_TABLE:
        if row["min"] <= block_size <= row["max"]:
            return row
    return TARIFF_TABLE[-1]  # beyond largest -> use last row

def compute_pilotage_in(
    length_m: Optional[float],
    breadth_m: Optional[float],
    max_summer_draught_m: Optional[float],
    routes: Optional[List[str]],
    baf_percentage: Optional[float] = None,
    cancellation_fee: Optional[float] = 0.0,
    delay_fee: Optional[float] = 0.0,
    storm_pilot_fee: Optional[float] = 0.0,
    special_case_fee: Optional[float] = 0.0,
    custom_volume_discount: Optional[float] = 0.0,
    invoice_text: Optional[str] = None
) -> Tuple[str, Dict[str, Any]]:
    """
    Returns (step_by_step_breakdown_str, json_summary_dict)
    Implements exact computation order and data usage rules.
    """

    warnings: List[str] = []
    notes: List[str] = []

    # 1) Parse invoice text (used only for missing values)
    parsed = parse_invoice_text(invoice_text or "")

    # Merge values: provided first, else parsed, else None/"not provided"
    def pick(name: str, provided: Optional[float]) -> Optional[float]:
        return provided if provided is not None else parsed.get(name)

    length_m = pick("length_m", length_m)
    breadth_m = pick("breadth_m", breadth_m)

    # Draught handling (prefer provided meters; if invoice has explicit dm, we will switch and note)
    draught_m = pick("max_summer_draught_m", max_summer_draught_m)
    draught_dm_explicit = parsed.get("draught_dm_explicit")

    # Fees
    baf_percentage = pick("baf_percentage", baf_percentage)
    cancellation_fee = pick("cancellation_fee", cancellation_fee) or 0.0
    delay_fee = pick("delay_fee", delay_fee) or 0.0
    storm_pilot_fee = pick("storm_pilot_fee", storm_pilot_fee) or 0.0
    special_case_fee = pick("special_case_fee", special_case_fee) or 0.0
    custom_volume_discount = pick("custom_volume_discount", custom_volume_discount) or 0.0

    # Validate routes
    routes = routes or []
    invalid = [r for r in routes if r not in ALLOWED_ROUTE_KEYS]
    if invalid:
        raise ValueError(f"Invalid route keys: {invalid}. Allowed: {ALLOWED_ROUTE_KEYS}")

    # Ensure required dimensions exist
    missing_core = []
    if length_m is None: missing_core.append("length_m")
    if breadth_m is None: missing_core.append("breadth_m")
    if draught_m is None and draught_dm_explicit is None: missing_core.append("max_summer_draught_m or draught_dm in invoice")
    if not routes: missing_core.append("routes")

    # Build inputs snapshot (before any conversions)
    inputs_snapshot = {
        "length_m": length_m if length_m is not None else "not provided",
        "breadth_m": breadth_m if breadth_m is not None else "not provided",
        "max_summer_draught_m": draught_m if draught_m is not None else "not provided",
        "routes": routes if routes else [],
        "baf_percentage": baf_percentage if baf_percentage is not None else "not provided",
        "cancellation_fee": cancellation_fee,
        "delay_fee": delay_fee,
        "storm_pilot_fee": storm_pilot_fee,
        "special_case_fee": special_case_fee,
        "custom_volume_discount": custom_volume_discount,
    }

    if missing_core:
        # We still return a structured response with warnings.
        breakdown = [
            "Antwerp Pilotage-In (Block-Size) – INCOMPLETE (missing required inputs)",
            f"Missing: {', '.join(missing_core)}",
            "",
            "Inputs:",
            json.dumps(inputs_snapshot, indent=2)
        ]
        summary = {
            "inputs": inputs_snapshot,
            "computed": {
                "block_size": None,
                "route_base_fees": [],
                "total_base_fee_eur": None,
                "additional_fees_total_eur": None,
                "volume_discount_rate": custom_volume_discount,
                "volume_discount_value_eur": None,
                "baf_amount_eur": None,
                "final_amount_eur": None,
            },
            "warnings": ["Missing core inputs; calculation not performed."],
            "notes": ["VBS is excluded by design."],
        }
        return "\n".join(breakdown), summary

    # 1) Block size (convert draught to dm)
    if draught_dm_explicit is not None:
        draught_dm = float(draught_dm_explicit)
        notes.append("Draught explicitly found in invoice as dm; used dm directly.")
    else:
        draught_dm = float(draught_m) * 10.0
        notes.append("Draught provided/assumed in meters; converted to dm by ×10.")

    block_size = float(length_m) * float(breadth_m) * float(draught_dm)

    # 2) Route base fees
    route_base_fees: List[Dict[str, Any]] = []
    total_base_fee = 0.0
    for route in routes:
        row = find_bracket(block_size)
        fee = float(row[route])
        route_base_fees.append({
            "route": route,
            "range_min": row["min"],
            "range_max": row["max"],
            "base_fee_eur": fee
        })
        total_base_fee += fee

    # 3) Additional fees
    additional_fees_total = float(cancellation_fee) + float(delay_fee) + float(storm_pilot_fee) + float(special_case_fee)

    # 4) Volume discount
    volume_discount_rate = float(custom_volume_discount) / 100.0 if custom_volume_discount else 0.0
    volume_discount_value = total_base_fee * volume_discount_rate

    # 5) BAF amount (basis = total_base_fee)
    baf_pct_used = float(baf_percentage) if baf_percentage is not None else 0.0
    if baf_percentage is None:
        warnings.append("BAF percentage not provided/found; treating BAF as 0. Final amount EXCLUDES BAF. Extract from invoice and rerun.")
    baf_amount = total_base_fee * (baf_pct_used / 100.0)

    # 6) Final amount
    final_amount = total_base_fee + additional_fees_total - volume_discount_value + baf_amount

    # Build breakdown text
    money = lambda x: f"€{x:,.2f}"
    lines = []
    lines.append("Antwerp Pilotage-In (Block-Size) – Calculation Breakdown")
    lines.append("NOTE: VBS is a separate line item and is NOT included.")
    lines.append("")
    lines.append("Inputs:")
    lines.append(f"- length_m: {length_m}")
    lines.append(f"- breadth_m: {breadth_m}")
    lines.append(f"- max_summer_draught_m: {max_summer_draught_m if max_summer_draught_m is not None else 'not provided'}")
    lines.append(f"- draught_used_dm: {draught_dm:.2f}")
    lines.append(f"- routes: {routes}")
    lines.append(f"- custom_volume_discount (%): {custom_volume_discount or 0}")
    lines.append(f"- baf_percentage (%): {baf_percentage if baf_percentage is not None else 'not provided (treated as 0)'}")
    lines.append(f"- cancellation_fee: {money(float(cancellation_fee))}")
    lines.append(f"- delay_fee: {money(float(delay_fee))}")
    lines.append(f"- storm_pilot_fee: {money(float(storm_pilot_fee))}")
    lines.append(f"- special_case_fee: {money(float(special_case_fee))}")
    lines.append("")
    lines.append(f"1) Block size = length × breadth × draught(dm) = {length_m} × {breadth_m} × {draught_dm:.2f} = {block_size:,.2f}")
    lines.append("2) Base fee per route (using bracket where min ≤ block_size ≤ max; if above all, last row):")
    for r in route_base_fees:
        lines.append(f"   - {r['route']}: bracket [{r['range_min']:,}–{r['range_max']:,}] -> {money(r['base_fee_eur'])}")
    lines.append(f"   total_base_fee = {money(total_base_fee)}")
    lines.append(f"3) Additional fees = {money(float(cancellation_fee))} (cancellation) + {money(float(delay_fee))} (delay) + "
                 f"{money(float(storm_pilot_fee))} (storm pilot) + {money(float(special_case_fee))} (special) "
                 f"= {money(additional_fees_total)}")
    lines.append(f"4) Volume discount = total_base_fee × {volume_discount_rate*100:.2f}% = {money(volume_discount_value)}")
    lines.append(f"5) BAF = total_base_fee × {baf_pct_used:.2f}% = {money(baf_amount)}   "
                 f"{'' if baf_percentage is not None else '(BAF missing; treated as 0)'}")
    lines.append(f"6) Final amount = {money(total_base_fee)} + {money(additional_fees_total)} - {money(volume_discount_value)} + {money(baf_amount)} = {money(final_amount)}")
    if warnings:
        lines.append("")
        lines.append("WARNINGS:")
        for w in warnings:
            lines.append(f"- {w}")
    if notes:
        lines.append("")
        lines.append("NOTES:")
        for n in notes:
            lines.append(f"- {n}")

    breakdown = "\n".join(lines)

    summary = {
        "inputs": {
            "length_m": length_m,
            "breadth_m": breadth_m,
            "max_summer_draught_m": max_summer_draught_m if max_summer_draught_m is not None else "not provided",
            "routes": routes,
            "baf_percentage": baf_percentage if baf_percentage is not None else "not provided",
            "cancellation_fee": float(cancellation_fee),
            "delay_fee": float(delay_fee),
            "storm_pilot_fee": float(storm_pilot_fee),
            "special_case_fee": float(special_case_fee),
            "custom_volume_discount": float(custom_volume_discount or 0.0),
        },
        "computed": {
            "block_size": round(block_size, 2),
            "route_base_fees": route_base_fees,
            "total_base_fee_eur": round(total_base_fee, 2),
            "additional_fees_total_eur": round(additional_fees_total, 2),
            "volume_discount_rate": round(volume_discount_rate * 100.0, 6),  # %
            "volume_discount_value_eur": round(volume_discount_value, 2),
            "baf_amount_eur": round(baf_amount, 2),
            "final_amount_eur": round(final_amount, 2),
        },
        "warnings": warnings,
        "notes": ["VBS is excluded by design."] + notes,
    }

    return breakdown, summary

def _cli():
    p = argparse.ArgumentParser(description="Antwerp Pilotage-In (Block-Size) fee calculator (VBS excluded).")
    p.add_argument("--length-m", type=float, help="Length overall (m)")
    p.add_argument("--breadth-m", type=float, help="Beam/Breadth (m)")
    p.add_argument("--draught-m", type=float, help="Max summer draught (m)")
    p.add_argument("--route", action="append", help="Allowed route key (can be passed multiple times)")
    p.add_argument("--baf-percentage", type=float, help="BAF percent (from invoice)")
    p.add_argument("--cancellation-fee", type=float, default=0.0)
    p.add_argument("--delay-fee", type=float, default=0.0)
    p.add_argument("--storm-pilot-fee", type=float, default=0.0)
    p.add_argument("--special-case-fee", type=float, default=0.0)
    p.add_argument("--custom-volume-discount", type=float, default=0.0)
    p.add_argument("--invoice-text", type=str, help="Raw invoice text (string)")
    p.add_argument("--invoice-text-file", type=str, help="Path to a file containing invoice text")
    p.add_argument("--json-only", action="store_true", help="Print JSON summary only")
    args = p.parse_args()

    invoice_text = args.invoice_text
    if args.invoice_text_file and os.path.exists(args.invoice_text_file):
        try:
            with open(args.invoice_text_file, "r", encoding="utf-8", errors="ignore") as fh:
                invoice_text = (invoice_text or "") + "\n" + fh.read()
        except Exception as e:
            print(json.dumps({"error": f"Failed to read invoice_text_file: {e}"}))
            return

    breakdown, summary = compute_pilotage_in(
        length_m=args.length_m,
        breadth_m=args.breadth_m,
        max_summer_draught_m=args.draught_m,
        routes=args.route,
        baf_percentage=args.baf_percentage,
        cancellation_fee=args.cancellation_fee,
        delay_fee=args.delay_fee,
        storm_pilot_fee=args.storm_pilot_fee,
        special_case_fee=args.special_case_fee,
        custom_volume_discount=args.custom_volume_discount,
        invoice_text=invoice_text
    )

    if args.json_only:
        print(json.dumps(summary, indent=2))
    else:
        print(breakdown)
        print("\nJSON Summary:\n" + json.dumps(summary, indent=2))

if __name__ == "__main__":
    _cli()
